// Prisma Schema for Student Finance Dashboard
// Generate client: npx prisma generate
// Create migration: npx prisma migrate dev --name init
// Deploy migration: npx prisma migrate deploy

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE ENTITIES
// =============================================================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String
  university      String?
  graduationYear  Int?      @map("graduation_year")
  major           String?
  phone           String?
  location        String?
  theme           String    @default("system")
  dateFormat      String    @default("MM/DD/YYYY") @map("date_format")
  baseCurrency    String    @default("USD") @map("base_currency")
  emailVerified   Boolean   @default(false) @map("email_verified")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt           DateTime? @map("deleted_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  // Relations
  accounts              Account[]
  categories            Category[]
  transactions          Transaction[]
  budgets               Budget[]
  groupsCreated         Group[]               @relation("GroupCreator")
  groupMemberships      GroupMember[]
  billSplitsCreated     BillSplit[]           @relation("SplitCreator")
  splitParticipations   SplitParticipant[]
  remindersSent         PaymentReminder[]      @relation("SentReminders")
  splitComments         SplitComment[]
  insights              Insight[]
  notificationSettings  NotificationSettings?
  notifications         Notification[]
  reports               Report[]
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]
  passwordResets        PasswordReset[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model Account {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  name          String
  accountType   String    @map("account_type") // 'checking', 'savings', 'credit', 'cash', 'other'
  balance       Decimal   @default(0) @db.Decimal(10, 2)
  currency      String    @default("USD")
  institution   String?
  accountNumber String?   @map("account_number")
  color         String    @default("#1e293b")
  icon          String    @default("account_balance")
  goalAmount    Decimal?  @map("goal_amount") @db.Decimal(10, 2)
  goalDate      DateTime? @map("goal_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([accountType])
  @@map("accounts")
}

model Category {
  id          String    @id @default(uuid())
  userId      String?   @map("user_id") // null for system categories
  name        String
  type        String    @default("expense") // 'income' or 'expense'
  color       String    @default("#95A5A6")
  icon        String?
  isSystem    Boolean   @default(false) @map("is_system")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      Budget[]

  @@unique([userId, name])
  @@index([userId])
  @@index([isSystem])
  @@map("categories")
}

model Transaction {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  accountId       String    @map("account_id")
  categoryId      String?   @map("category_id")
  amount          Decimal   @db.Decimal(10, 2)
  merchant        String
  description     String?   @db.Text
  transactionDate DateTime  @map("transaction_date")
  currency        String    @default("USD")
  tags            String[]  @default([])
  notes           String?   @db.Text
  status          String    @default("cleared") // 'pending', 'cleared'
  receiptUrl      String?   @map("receipt_url")
  aiCategorized   Boolean   @default(false) @map("ai_categorized")
  aiConfidence    Float     @default(0) @map("ai_confidence")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([transactionDate])
  @@index([merchant])
  @@map("transactions")
}

model Budget {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  categoryId     String    @map("category_id")
  name           String    @default("Budget")
  amount         Decimal   @db.Decimal(10, 2)
  periodType     String    @map("period") // 'monthly', 'semester', 'yearly'
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")
  alertThreshold Int       @default(80) @map("alert_threshold") // Percentage
  rollover       Boolean   @default(false) // Rollover unused budget to next period
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, periodType])
  @@index([userId])
  @@index([categoryId])
  @@index([startDate, endDate])
  @@map("budgets")
}

// =============================================================================
// BILL SPLITTING
// =============================================================================

model Group {
  id          String    @id @default(uuid())
  name        String
  description String?   @db.Text
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  creator User          @relation("GroupCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  members    GroupMember[]
  billSplits BillSplit[]

  @@index([createdBy])
  @@map("groups")
}

model GroupMember {
  id        String    @id @default(uuid())
  groupId   String    @map("group_id")
  userId    String    @map("user_id")
  role      String    @default("member") // 'owner', 'member'
  joinedAt  DateTime  @default(now()) @map("joined_at")
  deletedAt DateTime? @map("deleted_at")
  isActive  Boolean   @default(true) @map("is_active")

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

model BillSplit {
  id          String    @id @default(uuid())
  groupId     String?   @map("group_id")
  createdBy   String    @map("created_by")
  description String    @db.Text
  totalAmount Decimal   @map("total_amount") @db.Decimal(10, 2)
  currency    String    @default("GBP")
  splitType   String    @map("split_type") // 'equal', 'percentage', 'custom'
  status      String    @default("pending") // 'pending', 'partial', 'settled', 'cancelled'
  billDate    DateTime  @default(now()) @map("bill_date")
  settledAt   DateTime? @map("settled_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  group        Group?             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  creator      User               @relation("SplitCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  participants SplitParticipant[]
  comments     SplitComment[]

  @@index([groupId])
  @@index([createdBy])
  @@index([billDate])
  @@map("bill_splits")
}

model SplitParticipant {
  id            String    @id @default(uuid())
  splitId       String    @map("split_id")
  userId        String    @map("user_id")
  amountOwed    Decimal   @map("amount_owed") @db.Decimal(10, 2)
  amountPaid    Decimal   @default(0) @map("amount_paid") @db.Decimal(10, 2)
  status        String    @default("pending") // 'pending', 'partial', 'paid'
  paidAt        DateTime? @map("paid_at")
  paymentMethod String?   @map("payment_method")
  paymentNote   String?   @map("payment_note") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  split            BillSplit         @relation(fields: [splitId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentReminders PaymentReminder[]

  @@unique([splitId, userId])
  @@map("split_participants")
}

model SplitComment {
  id        String   @id @default(uuid())
  splitId   String   @map("split_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  split BillSplit @relation(fields: [splitId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([splitId])
  @@index([userId])
  @@map("split_comments")
}

model PaymentReminder {
  id                 String   @id @default(uuid())
  splitParticipantId String   @map("split_participant_id")
  sentBy             String   @map("sent_by")
  sentAt             DateTime @default(now()) @map("sent_at")
  reminderType       String   @default("email") @map("reminder_type") // 'polite', 'urgent'
  status             String   @default("sent")

  // Relations
  participant SplitParticipant @relation(fields: [splitParticipantId], references: [id], onDelete: Cascade)
  sender      User             @relation("SentReminders", fields: [sentBy], references: [id], onDelete: Cascade)

  @@index([splitParticipantId])
  @@index([sentBy])
  @@map("payment_reminders")
}

// =============================================================================
// AI & INSIGHTS
// =============================================================================

model Insight {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  insightType String    @map("insight_type") // 'warning', 'positive', 'tip', 'prediction'
  title       String
  message     String    @db.Text
  actionType  String?   @map("action_type")
  actionData  Json?     @map("action_data")
  priority    Int       @default(5)
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([insightType])
  @@map("insights")
}

model AICategoryCache {
  id         String   @id @default(uuid())
  merchant   String   @unique
  category   String
  confidence Float
  source     String // 'ai' or 'rules'
  hitCount   Int      @default(1) @map("hit_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([merchant])
  @@map("ai_category_cache")
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model NotificationSettings {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  emailNotifications   Boolean  @default(true) @map("email_notifications")
  pushNotifications    Boolean  @default(true) @map("push_notifications")
  budgetAlerts         Boolean  @default(true) @map("budget_alerts")
  paymentReminders     Boolean  @default(true) @map("payment_reminders")
  insightNotifications Boolean  @default(true) @map("insight_notifications")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

model Notification {
  id      String    @id @default(uuid())
  userId  String    @map("user_id")
  type    String // 'budget', 'payment', 'insight', 'system'
  title   String
  message String    @db.Text
  link    String?
  readAt  DateTime? @map("read_at")
  sentAt  DateTime  @default(now()) @map("sent_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sentAt(sort: Desc)])
  @@index([type])
  @@map("notifications")
}

// =============================================================================
// REPORTS
// =============================================================================

model Report {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  reportType  String   @map("report_type") // 'monthly', 'semester', 'yearly', 'custom'
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  data        Json // Store report data as JSON
  format      String   @default("json") // 'json', 'pdf', 'csv'
  generatedAt DateTime @default(now()) @map("generated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, periodStart, periodEnd])
  @@map("reports")
}

// =============================================================================
// AUDIT & SECURITY
// =============================================================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique // Hashed token (SHA-256)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type") // 'transaction', 'budget', 'split'
  entityId   String?  @map("entity_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)])
  @@index([action])
  @@map("audit_log")
}
